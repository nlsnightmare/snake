!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);const s=document.getElementById("canvas");let n=s.getContext("2d");n.height=s.height,n.width=s.width,n.clear=(t=>{n.fillStyle=t,n.fillRect(0,0,s.width,s.height)});var h=n;class o{constructor(t,e){this.n=t,this.m=e,this.data=new Array(t*e),this.size=t*e;for(let i=0;i<t;i++)for(let t=0;t<e;t++)i==t?this.setItem(i,t,1):this.setItem(i,t,0)}toArray(){return this.data}transpose(){let t=new o(this.m,this.n);for(let e=0;e<this.n;e++)for(let i=0;i<this.m;i++)t.setItem(i,e,this.getItem(e,i));return t}static zero(t,e){let i=new o(t,e);for(let t=0;t<i.data.length;t++)i.data[t]=0;return i}loadData(t){if(t.length!=this.data.length)throw new Error("Matrix data should be exactly "+this.n*this.m);for(let e=0;e<t.length;e++)this.data[e]=t[e]}display(){for(let t=0;t<this.n;t++)for(let e=0;e<this.m;e++)console.log(`(${t},${e}) =>`,this.getItem(t,e))}setItem(t,e,i){if(1!=this.m)this.data[t+e*this.n]=i;else{let s=e+t;this.data[s]=i}}getItem(t,e){return this.data[t+e*this.n]}randomize(){for(let t=0;t<this.data.length;t++)this.data[t]=2*Math.random()-1}copy(){let t=new o(this.n,this.m);for(let e=0;e<this.data.length;e++)t.data[e]=this.data[e];return t}add(t){for(let e=0;e<this.data.length;e++)this.data[e]+=t}mul(t){if(this.m!=t.n)throw new Error(`Trying to multiply a (${this.n},${this.m}) matrix with a (${t.n},${t.m})`);let e=o.zero(t.m,this.n);for(let i=0;i<this.n;i++)for(let s=0;s<t.m;s++){let n=0;for(let e=0;e<this.m;e++)n+=this.getItem(i,e)*t.getItem(e,s);e.setItem(i,s,n)}return e}}class r{constructor(...t){let e,i,s,n,h;"object"==typeof t[0]?(e=t[0].inputs,s=t[0].hidden.slice(0),i=t[0].outputs,n=t[0].normalizeInput,h=t[0].normalizeOutput,s.push(i),this.options=t[0]):(e=t[0],s=t[1],i=t[2],this.options={inputs:t[0],hidden:[t[1]],outputs:t[2]}),this.score=0,this.inputs=e,this.outputs=i,this.normalizeInput=void 0===n||n,this.normalizeOutput=void 0===h||h,this.layers=[],this.layers.push(new o(e+1,s[0]));for(let t=0;t<s.length;t++)this.layers.push(new o(this.layers[t].m+1,s[t]));this.layers.forEach(t=>t.randomize())}compute(t){let e=t.slice(0);if(this.normalizeInput){let t=Math.max(...e);0==t&&(t=1),e=e.map(e=>e/t)}e.push(1);let i=new o(1,e.length);i.data=e;let s,n,h=i;for(s=0;s<this.layers.length-1;s++){let t=this.layers[s];(h=(h=h.mul(t)).transpose()).data.push(1),h.m++,h.data=h.data.map(Math.tanh)}let r=h.mul(this.layers[s]);return this.normalizeOutput?{percentages:n=(a=r.data).map(function(t,e){return Math.exp(t)/a.map(function(t){return Math.exp(t)}).reduce(function(t,e){return t+e})}),max:s=n.indexOf(Math.max(...n))}:r.data.slice();var a}getGenes(){let t=[];for(let e of this.layers)t=t.concat(e.data);return t}setGenes(t){for(let e of this.layers)e.data=t.splice(0,e.size)}crossover(t,e){let i=this.getGenes(),s=t.getGenes();if(i.length!=s.length)throw new Error("Can't crossover between two networks of different size!");let n=[];for(let t=0;t<i.length;t++)if(Math.random()>.5?n.push(i[t]):n.push(s[t]),Math.random()<e){let e=2*Math.random()-1;n[t]=e}let h=new r(this.options);return h.setGenes(n),h}}class a{constructor(t){this.size=t}draw(){h.fillStyle="darkgrey",h.fillRect(this.x,this.y,this.size,this.size)}}class l{constructor(t,e){this.size=15,this.x=t*this.size,this.y=e*this.size}draw(){h.fillStyle="red",h.fillRect(this.x,this.y,this.size,this.size)}}document.getElementById("info");const c=500;function d(){let t=Math.floor(19*Math.random()*2),e=Math.floor(19*Math.random()*2);return new l(t,e)}let f=80;class u{constructor(t,e,i){this.name=i,this.size=15,this.x=t*this.size,this.y=e*this.size,this.direction=1,this.timepassed=0,this.lifetime=0,this.liferemaining=c,this.tail=[],this.food=d();for(let t=0;t<4;t++)this.tail.push(new a(this.size));this.brain=new r({inputs:28,hidden:[20],outputs:4,normalizeInput:!1}),this.fitness=0}getTailDirection(){let t=this.tail[0],e=t.x-this.x,i=t.y-this.y;return e>0?3:e<0?1:i>0?0:2}turn(t){this.direction+t%2!=0&&(this.direction=t)}calculateDistances(){let t=[],e=this.lookAt(this.size,0);return t[0]=e[0],t[1]=e[1],t[2]=e[2],e=this.lookAt(-this.size,0),t[3]=e[0],t[4]=e[1],t[5]=e[2],e=this.lookAt(0,-this.size),t[6]=e[0],t[7]=e[1],t[8]=e[2],e=this.lookAt(0,this.size),t[9]=e[0],t[10]=e[1],t[11]=e[2],e=this.lookAt(this.size,this.size),t[12]=e[0],t[13]=e[1],t[14]=e[2],e=this.lookAt(this.size,-this.size),t[15]=e[0],t[16]=e[1],t[17]=e[2],e=this.lookAt(-this.size,-this.size),t[18]=e[0],t[19]=e[1],t[20]=e[2],e=this.lookAt(-this.size,this.size),t[21]=e[0],t[22]=e[1],t[23]=e[2],t[24]=0==this.direction?1:0,t[25]=1==this.direction?1:0,t[26]=2==this.direction?1:0,t[27]=3==this.direction?1:0,t}turnAI(t){this.direction=4+this.direction,this.direction+=t,this.direction%=4}update(t){if(this.timepassed+=t,this.timepassed<f)return;this.timepassed=0,this.lifetime++,this.liferemaining--;let e=this.brain.compute(this.calculateDistances());(e.max+this.direction)%2!=0&&(this.direction=e.max),0==this.liferemaining&&this.die(),this.x==this.food.x&&this.y==this.food.y&&this.eat();for(let t=this.tail.length-1;t>=1;t--){let e=this.tail[t],i=this.tail[t-1];if(this.x==e.x&&this.y==e.y)return void this.die();e.x=i.x,e.y=i.y}switch(this.tail[0].x=this.x,this.tail[0].y=this.y,this.direction){case 0:this.y-=this.size;break;case 1:this.x+=this.size;break;case 2:this.y+=this.size;break;case 3:this.x-=this.size}(this.x<0||this.y<0||this.x>=h.width||this.y>=h.height)&&this.die(),this.calculateFitness()}die(){this.direction=4}draw(){if(4!=this.direction){for(let t of this.tail)t.draw();this.food.draw();let t=2.5*this.name;h.fillStyle=`rgb(${this.name+30},${t},${255-2.5*this.name})`,h.fillRect(this.x,this.y,this.size,this.size)}}eat(){this.fitness+=300,this.liferemaining+=c,this.tail.push(new a(this.size)),this.food=d()}isOnTail(t,e){for(let i of this.tail)if(i.x==t&&i.y==e)return!0;return!1}lookAt(t,e){let i={x:this.x,y:this.y},s=!1,n=!1,o=[0,0,0],r=0;for(;i.x<=h.width&&i.x>=0&&i.y<=h.height&&i.y>=0;)r++,s||this.food.x!=i.x||this.food.y!=i.y||(s=!0,o[0]=1),!n&&this.isOnTail(i.x,i.y)&&(n=!0,o[1]=1),i.x+=t,i.y+=e;return o[2]=1/r,o}calculateFitness(){this.tail.length<10?this.fitness=Math.pow(this.lifetime,2)*Math.pow(this.tail.length-3,2)/1e3:this.fitness=Math.pow(this.lifetime,2)*Math.pow(this.tail.length,2)/100}}let m=1;const p=document.getElementById("speed"),g=(document.getElementById("best"),document.getElementById("load"));function y(t){let e=Math.floor(19),i=Math.floor(19);return new u(e,i,t)}console.log(g),g.onclick=function(){console.log("a"),$=[],v=[];let t=y(),e=JSON.parse("["+localStorage.getItem("best")+"]");console.log(e),t.brain.setGenes(e),$.push(t)},p.oninput=(t=>{m=t.target.value});const w=1e3,x=document.getElementById("lbl");let z,b,M,I,k=0,v=[],$=[];function A(){z=performance.now(),M=z-b,b=z,h.clear("black");for(let t of $)t.draw();x.innerHTML=`Generation: ${k} alive: ${$.length}`;for(let t=0;t<m;t++){for(let t=$.length-1;t>=0;t--)4!=$[t].direction?$[t].update(M):v.push($.splice(t,1)[0]);0==$.length&&E()}requestAnimationFrame(A)}function E(){let t;I=-1/0;let e=0;for(let i of v)e+=i.fitness,i.fitness>I&&(t=i,I=i.fitness);e/=v.length,console.log(`${k} generation's average: ${e}`),console.log(`${k} generation's best: ${I} length: ${t.tail.length}`);for(let t=0;t<w-1;t++){let e=O(),i=O();$[t]=y(t),$[t].brain=e.brain.crossover(i.brain,.02)}$.push(t),function(t){if("undefined"==typeof localStorage)return void alert("local storage not supported");localStorage.getItem("bestfitness")<t.fitness&&(console.log("New Best!"),localStorage.setItem("best",t.brain.getGenes()),localStorage.setItem("bestfitness",t.fitness))}(t),t.fitness=0,v=[],k++}function O(){let t=0;for(;;){let e=Math.floor(Math.random()*v.length);if(Math.floor(Math.random()*I)<v[e].fitness)return v[e];t++}if(t>=1e3)throw new Error("AcceptReject couldn't find a snake!")}window.onload=(()=>{for(let t=0;t<w;t++)$.push(y(t));b=performance.now(),requestAnimationFrame(A)})}]);